<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Slip Anggaran</title>
  <link rel="icon" type="png" href="acc1.png">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="loading" class="text-center" style="margin-top:50px;">‚è≥ Memeriksa sesi login...</div>

  <div class="slip fade-in hidden" id="mainApp">
    <h2>Slip Anggaran</h2>
    <div class="info">
      <div><span>User:</span> <span id="slip-user"></span></div>
      <div><span>Tanggal:</span> <span id="slip-tanggal"></span></div>
      <div><span>ID:</span> <span id="slip-id"></span></div>
    </div>
    <div class="item"><span>Total Masuk:</span> <span id="slip-masuk">0</span></div>
    <div class="item"><span>Total Keluar:</span> <span id="slip-keluar">0</span></div>
    <div class="item total"><span>Saldo:</span> <span id="slip-saldo">0</span></div>
    <div class="history" id="history"><h3>5 Transaksi Terakhir</h3></div>
  </div>
  <div class="btn-container">
  <button onclick="window.location.href='index.html'" class="btn-secondary"><span>Kembali</span></button>
  <button onclick="cetakSlip()" class="btn-secondary">üñ®Ô∏è Cetak Slip</button>
  <button onclick="downloadPDF()" class="btn-success">‚¨áÔ∏è Download PDF</button>
</div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script> 
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <script>
    // Cetak slip langsung ke printer
    function cetakSlip() {
      window.print();
    }

    // Download slip jadi PDF (versi daftar transaksi)
    async function downloadPDF() {
      const user = firebase.auth().currentUser;
      if (!user) {
        alert("‚ùå Anda harus login dulu.");
        return;
      }

      // Ambil namaUser dari koleksi users
      const userDoc = await db.collection("users").doc(user.uid).get();
      const namaUser = userDoc.exists ? userDoc.data().nama : "-";

      // Ambil data transaksi dari Firestore
      const snapshot = await db.collection("transaksi")
        .where("userId", "==", user.uid)
        .get();

      const transaksi = snapshot.docs.map(doc => doc.data());
      // Urutan berdasarkan tanggal terbaru
      transaksi.sort((a, b) => {
        const timeA = a.tanggal ? new Date(a.tanggal).getTime() : (a.createdAtMillis || 0);
        const timeB = b.tanggal ? new Date(b.tanggal).getTime() : (b.createdAtMillis || 0);
        return timeA - timeB; // terbaru di atas
      });

      const totalMasuk = transaksi.filter(t => t.tipe==="masuk").reduce((a,b)=>a+b.jumlah,0);
      const totalKeluar = transaksi.filter(t => t.tipe==="keluar").reduce((a,b)=>a+b.jumlah,0);
      const saldo = totalMasuk-totalKeluar;

      // Buat isi tabel transaksi
      let rows = "";
      transaksi.forEach((t, i) => {
        rows += `
          <tr>
            <td style="border:1px solid #ccc; padding:6px; text-align:center;">${i+1}</td>
            <td style="border:1px solid #ccc; padding:6px;">${new Date(t.tanggal).toLocaleDateString('id-ID')}</td>
            <td style="border:1px solid #ccc; padding:6px;">${t.keterangan}</td>
            <td style="border:1px solid #ccc; padding:6px; text-align:right; color:${t.tipe==='masuk'?'green':'red'}">
              ${t.tipe==='masuk'?'+':'-'} Rp ${t.jumlah.toLocaleString()}
            </td>
          </tr>
        `;
      });

      // Buat template HTML slip untuk PDF
      const htmlPDF = `
        <div style="font-family: Arial, sans-serif; padding:20px; color:#000;">
          <h2 style="text-align:center; margin-bottom:5px; color:black">Daftar Transaksi</h2>
          <p style="text-align:center; margin:0;">${new Date().toLocaleString("id-ID")}</p>
          <hr style="margin:15px 0;">
          
          <p><b>Nama Aplikasi:</b> Anggaran Rumah Tangga</p>
          <p><b>Nama Pengguna:</b> ${namaUser}</p>
          <p><b>ID Slip:</b> TX-${Date.now().toString().slice(-6)}</p>
          
          <table style="width:100%; border-collapse:collapse; margin-top:15px; font-size:13px;">
            <tr style="background:#f2f2f2;">
              <th style="border:1px solid #ccc; padding:6px; text-align:center; color: black ">No</th>
              <th style="border:1px solid #ccc; padding:6px; color: black">Tanggal</th>
              <th style="border:1px solid #ccc; padding:6px; color: black">Keterangan</th>
              <th style="border:1px solid #ccc; padding:6px; color: black">Jumlah</th>
            </tr>
            ${rows}
          </table>

          <hr style="margin:15px 0;">
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <tr>
              <td style="border:1px solid #ccc; padding:6px;">Total Masuk</td>
              <td style="border:1px solid #ccc; padding:6px;">Rp ${totalMasuk.toLocaleString()}</td>
            </tr>
            <tr>
              <td style="border:1px solid #ccc; padding:6px;">Total Keluar</td>
              <td style="border:1px solid #ccc; padding:6px;">Rp ${totalKeluar.toLocaleString()}</td>
            </tr>
            <tr style="font-weight:bold; background:#f9f9f9;">
              <td style="border:1px solid #ccc; padding:6px;">Saldo</td>
              <td style="border:1px solid #ccc; padding:6px;">Rp ${saldo.toLocaleString()}</td>
            </tr>
          <p style="font-size:11px; text-align:center; margin-top:40px; color:#555;">
            ¬© ${new Date().getFullYear()} Nasyiruddin | Sistem Anggaran Rumah Tangga
          </p>
        </div>
      `;

      // Export ke PDF
      const opt = {
        margin:       0.5,
        filename:     'daftar-transaksi.pdf',
        image:        { type: 'jpeg', quality: 1.0 }, // Tingkat kualitas gambar
        html2canvas:  { scale: 4, scrollY:0, useCORS: true }, // Resolusi lebih tinggi
        jsPDF:        { unit: 'cm', format: 'a4', orientation: 'portrait' }, 
        pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] } // Hindari pemotongan tabel 
      };
      html2pdf().set(opt).from(htmlPDF).save();
    }
    
    const firebaseConfig = {
      apiKey: "AIzaSyBrspKOn3db7J5rpehHu8VCGIgPdQBcLls",
      authDomain: "anggaran-rumah-tangga.firebaseapp.com",
      projectId: "anggaran-rumah-tangga",
      storageBucket: "anggaran-rumah-tangga.appspot.com",
      messagingSenderId: "681556356369",
      appId: "1:681556356369:web:6ddd11deba0033791bb0b0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged(async user => {
      const loading = document.getElementById("loading");
      const mainApp = document.getElementById("mainApp");

      if (!user) {
        window.location.href = "login.html";
        return;
      }

      loading.style.display = "none";
      mainApp.classList.remove("hidden");

      const userDoc = await db.collection("users").doc(user.uid).get();
      const namaUser = userDoc.exists ? userDoc.data().nama : "-";
      const snapshot = await db.collection("transaksi")
        .where("userId", "==", user.uid)
        .get();
        
      const transaksi = snapshot.docs.map(doc => doc.data());
      // Urutan berdasarkan tanggal terbaru
      
      transaksi.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
      const totalMasuk = transaksi.filter(t => t.tipe==="masuk").reduce((a,b)=>a+b.jumlah,0);
      const totalKeluar = transaksi.filter(t => t.tipe==="keluar").reduce((a,b)=>a+b.jumlah,0);
      const saldo = totalMasuk-totalKeluar;

      document.getElementById("slip-user").textContent = namaUser; // Nama pengguna
      document.getElementById("slip-tanggal").textContent = new Date().toLocaleString("id-ID");
      document.getElementById("slip-id").textContent = "TX-" + Date.now().toString().slice(-6);
      document.getElementById("slip-masuk").textContent = "Rp " + totalMasuk.toLocaleString();
      document.getElementById("slip-keluar").textContent = "Rp " + totalKeluar.toLocaleString();
      document.getElementById("slip-saldo").textContent = "Rp " + saldo.toLocaleString();

      const lastTrx = transaksi.slice(0,5);
      const historyDiv = document.getElementById("history");
      if (lastTrx.length === 0) {
        historyDiv.innerHTML += "<div class='text-center'>Belum ada transaksi</div>";
      } else {
        lastTrx.forEach(t=>{
          historyDiv.innerHTML += `
            <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
              <span>${new Date(t.tanggal).toLocaleDateString('id-ID')} - ${t.keterangan}</span>
              <span style="color:${t.tipe==='masuk'?'#28a745':'#ff6b6b'}">
                ${t.tipe==='masuk'?'+':'-'}Rp ${t.jumlah.toLocaleString()}
              </span>
            </div>`;
        });
      }
    });
  </script>
</body>
</html>




